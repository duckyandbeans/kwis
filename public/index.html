<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/main.js" defer></script>
</head>
<body class="bg-light d-flex align-items-center justify-content-center" style="height: 100vh;">

<div class="card shadow p-4" style="max-width: 400px; width: 100%;">
    <h3 class="text-center mb-3">üè´ Student Login</h3>

    <div id="step-identify">
        <div class="mb-3">
            <label class="form-label">Grade</label>
            <select id="grade" class="form-select" onchange="toggleClasses()">
                <option value="">Select...</option>
                <option value="X">Class X</option>
                <option value="XI">Class XI</option>
                <option value="XII">Class XII</option>
            </select>
        </div>
        
        <div class="mb-3 d-none" id="class-container">
            <label class="form-label">Class Section</label>
            <select id="class_section" class="form-select">
                </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Absen Number</label>
            <input type="number" id="number" class="form-control" placeholder="e.g. 15">
        </div>

        <button onclick="checkStudent()" class="btn btn-primary w-100">Find Me</button>
    </div>

    <div id="step-code" class="d-none mt-3">
        <div class="alert alert-success">
            Hello, <strong id="student-name-display"></strong>!
        </div>
        <label class="form-label">Teacher Code</label>
        <input type="text" id="teacher-code" class="form-control mb-3" placeholder="Look at the whiteboard...">
        <button onclick="verifyCode()" class="btn btn-success w-100">Start Kwis</button>
    </div>
</div>

<script>
    function toggleClasses() {
        const grade = document.getElementById('grade').value;
        const container = document.getElementById('class-container');
        const select = document.getElementById('class_section');
        
        if(grade) {
            container.classList.remove('d-none');
            select.innerHTML = "";
            // Add classes A-I (matches your CSV)
            ['A','B','C','D','E','F','G','H','I'].forEach(c => {
                select.innerHTML += `<option value="${c}">Class ${c}</option>`;
            });
        } else {
            container.classList.add('d-none');
        }
    }

    async function checkStudent() {
        const grade = document.getElementById('grade').value;
        const cls = document.getElementById('class_section').value;
        const num = document.getElementById('number').value;

        if(!grade || !cls || !num) return alert("Please fill all fields");

        const res = await postData('/api/auth/find_student.py', { 
            grade, class_id: cls, number: num 
        });

        if(res && res.found) {
            document.getElementById('step-identify').classList.add('d-none');
            document.getElementById('step-code').classList.remove('d-none');
            document.getElementById('student-name-display').innerText = res.name;
            
            // Save ID for the quiz page
            sessionStorage.setItem('student_id', res.id); 
            sessionStorage.setItem('student_name', res.name);
        } else {
            alert("Student not found! Check your Class and Number.");
        }
    }

    async function verifyCode() {
        const code = document.getElementById('teacher-code').value;
        const res = await postData('/api/auth/verify_code.py', { code });

        if(res && res.valid) {
            // Redirect to the generic quiz page with the Quiz ID in the URL
            window.location.href = `kwis.html?id=${res.quiz_id}`;
        } else {
            alert("Invalid Code!");
        }
    }
</script>
</body>
</html>
