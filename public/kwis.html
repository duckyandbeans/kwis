<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Kwis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="js/autosave.js"></script>
    <script src="js/main.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .quiz-container { max-width: 800px; margin: 40px auto; }
        .feedback { font-weight: bold; margin-top: 10px; display: none; }
        .correct { color: #198754; } /* Green */
        .wrong { color: #dc3545; }   /* Red */
        .pending { color: #fd7e14; } /* Orange */
    </style>
</head>
<body>

    <div class="container quiz-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary">üìù Kwis Time</h2>
            <div>
                <span class="text-muted">Student:</span>
                <span class="badge bg-info text-dark fs-6" id="student-display">Guest</span>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-4">
                
                <form id="quiz-form" onsubmit="submitQuiz(event)">
                    
                    <div class="mb-4 p-3 border rounded bg-white">
                        <label class="form-label fw-bold">1. Present Simple: She _____ to school every day.</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q1" value="A" id="q1a">
                            <label class="form-check-label" for="q1a">A) go</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q1" value="B" id="q1b">
                            <label class="form-check-label" for="q1b">B) goes</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q1" value="C" id="q1c">
                            <label class="form-check-label" for="q1c">C) going</label>
                        </div>
                        <div id="feedback-q1" class="feedback"></div>
                    </div>

                    <div class="mb-4 p-3 border rounded bg-white">
                        <label class="form-label fw-bold">2. Writing: Write a sentence using "Yesterday".</label>
                        <textarea name="q2" class="form-control" rows="3" placeholder="Type your answer here..."></textarea>
                        <div id="feedback-q2" class="feedback"></div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Submit Answers</button>
                    </div>
                    
                    <div id="final-score" class="alert alert-success mt-3 d-none text-center"></div>

                </form>
            </div>
        </div>
    </div>

    <script>
        // 1. On Load: Check Login & Restore Name
        document.addEventListener('DOMContentLoaded', () => {
            const studentName = sessionStorage.getItem('student_name');
            const studentId = sessionStorage.getItem('student_id');
            
            if (!studentId) {
                alert("You are not logged in!");
                window.location.href = 'index.html'; // Kick them back to login
            } else {
                document.getElementById('student-display').innerText = studentName;
            }
        });

        // 2. The Submit Logic
        async function submitQuiz(e) {
            e.preventDefault();
            
            // Get Quiz ID from the URL (e.g. ?id=quiz_english_tenses_01)
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('id');
            const studentId = sessionStorage.getItem('student_id');

            if(!quizId) return alert("Error: No Quiz ID found in URL.");

            // Collect Answers
            const form = document.getElementById('quiz-form');
            const formData = new FormData(form);
            const answers = {};
            formData.forEach((value, key) => answers[key] = value);

            // UI Feedback: Loading
            const btn = document.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Grading...";

            // Send to Python Backend (Note the .py extension!)
            const res = await postData('/api/submit_quiz.py', {
                student_id: studentId,
                quiz_id: quizId,
                answers: answers
            });

            // Handle Response
            if(res) {
                // Show Final Score
                const scoreBox = document.getElementById('final-score');
                scoreBox.innerText = `üéâ Submission Complete! MCQ Score: ${res.mcq_score}`;
                scoreBox.classList.remove('d-none');

                // Show Individual Feedback
                // Q1
                const f1 = document.getElementById('feedback-q1');
                f1.style.display = 'block';
                if(res.feedback.q1 === "CORRECT") {
                    f1.innerText = "‚úÖ Correct! Bagus!";
                    f1.className = "feedback correct";
                } else {
                    f1.innerText = "‚ùå Incorrect.";
                    f1.className = "feedback wrong";
                }

                // Q2
                const f2 = document.getElementById('feedback-q2');
                f2.style.display = 'block';
                if(res.feedback.q2 === "PENDING") {
                    f2.innerText = "‚è≥ Saved for Teacher Review.";
                    f2.className = "feedback pending";
                }

                // Clear AutoSave so the next student starts fresh
                if(window.clearAutoSave) window.clearAutoSave();
                
                btn.innerText = "Submitted";
            } else {
                // Reset button if error
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>
